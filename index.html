<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CONTABILIDAD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1770260995/contabilidad_ezjhdd.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
  :root{
    --primary:#06402B;
    --primary-2:#04281C;
    --ok:#16a34a;
    --error:#dc2626;
    --scrim:rgba(0,0,0,.35);
  }
  html,body{
    margin:0; padding:0; height:100%; width:100%;
    overflow-x:hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#111;
    background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905869/fondo_amarillo_a1catz.png') center/cover fixed no-repeat;
  }
  .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

  .view{ display:none; opacity:0; transform: translateY(8px);
    transition: opacity .25s ease, transform .25s ease;
    box-sizing:border-box; padding:16px;
  }
  .view.active{ display:block; opacity:1; transform: translateY(0); }

  .card{
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px);
    border: 2px solid #ddd;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0,0,0,.18);
    max-width: 820px;
    margin: 16px auto;
    padding: 20px 20px 16px;
  }
  h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
  p.helper{ color:#444; font-size:.95rem; text-align:center; margin:8px 0 16px; }
  label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
  input, select, textarea, button{
    width:100%; padding:12px; box-sizing:border-box;
    border:1.5px solid #ccc; border-radius:8px; background:#fff;
    outline:none; transition: border-color .2s ease, transform .08s ease;
    font-size:16px;
  }
  input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
  button{
    cursor:pointer; border:2px solid var(--primary);
    background:#fff; color:#000; font-weight:700;
  }
  button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
  .btn-primary{ background:var(--primary); color:#fff; }
  .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
  .btn-row > *{ flex:1; }
  .muted{ color:#666; font-size:.85rem; }
  .center{ text-align:center; }
  .image-center{ display:flex; justify-content:center; }
  .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
  .banner-bottom{ width:240px; border-radius:12px; display:block; margin:16px auto 8px; }
  .chip{
    padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
    background:#fff; font-weight:700; color:#000; text-decoration:none;
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
  }
  .danger{ background:#e11; border-color:#e11; color:#fff; }

  /* Botones de icono: sin recuadro ni fondo */
  .btn-icon{
    background: transparent !important;
    border: 0 !important;
    box-shadow: none !important;
    padding: 10px !important;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .btn-icon:hover,
  .btn-icon:active{
    background: transparent !important;
    color: inherit !important;
    border: 0 !important;
  }
  .btn-icon:focus-visible{
    outline: none;
    box-shadow: 0 0 0 3px rgba(4,40,28,.28);
    border-radius: 10px;
  }
  .btn-icon img{
    width: 80px; height: 80px; display: block;
    border: 0; border-radius: 0; background: transparent;
    pointer-events: none;
  }

  /* Loader centrado */
  .loader{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
    z-index:9999; backdrop-filter: blur(2px);
    opacity:1; transition: opacity .12s ease;
    will-change: opacity;
  }
  .loader.hidden{
    opacity:0; pointer-events:none;
  }

  .spinner-ios{
    position:relative; width:64px; height:64px;
  }
  .spinner-ios i{
    position:absolute; left:50%; top:50%;
    width:6px; height:18px; margin:-9px 0 0 -3px;
    background:#fff; border-radius:3px;
    opacity:.2;
    animation:iosFade 1.2s linear infinite;
    transform-origin: center center;
  }
  @keyframes iosFade{
    0%, 39%, 100% { opacity:.2; }
    40% { opacity:1; }
  }
  .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
  .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
  .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
  .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
  .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
  .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
  .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
  .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
  .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
  .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
  .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
  .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

  .hidden{ display:none !important; }

  .narrow{ max-width: 560px; margin: 0 auto; }
  .spaced{ margin-top:12px; }

  /* Listados reutilizables */
  .list-grid{
    display:flex; flex-direction:column; gap:14px;
    margin-top:14px;
  }
  .item-card{
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px);
    border: 2px solid #ddd;
    border-radius:16px;
    padding:14px 16px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  /* Fila de acciones en cada contratista (reutilizada) */
  .contr-actions .right-group .btn-icon{
    flex:0 0 auto;
    width:auto;
    display:inline-flex !important;
    align-items:center;
    justify-content:center;
    padding:6px !important;
    border:0 !important;
    background:transparent !important;
    box-shadow:none !important;
    cursor:pointer;
    transition:transform .12s ease;
  }
  .contr-actions .right-group .btn-icon:hover{ transform:scale(1.08); }
  .contr-actions .right-group .btn-icon:active{ transform:scale(.94); }
  .contr-actions .right-group .btn-icon img{
    width:44px !important;
    height:44px !important;
    display:block;
    object-fit:contain;
    pointer-events:none;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));
  }
  @media (max-width:700px){
    .contr-actions .right-group .btn-icon img{
      width:40px !important;
      height:40px !important;
    }
  }

  .item-header{
    display:flex; flex-wrap:wrap;
    gap:8px; align-items:center; justify-content:space-between;
  }
  .item-title{
    font-weight:900; font-size:1rem; color:var(--primary); margin:0;
  }
  .item-sub{
    font-size:.72rem; font-weight:700; color:#333; margin:0;
  }

  .tag-count{
    display:inline-block;
    border-radius:999px;
    padding:8px 16px;
    font-weight:900; text-align:center;
    color:#06402B; background:#d7f8e3;
    border:3px solid #7adf9b;
    box-shadow:0 4px 10px rgba(0,0,0,.12);
    min-width:120px;
  }
  .filter-input{
    appearance:none;
    border-radius:999px;
    background:#fff;
    border:3px solid #06402B;
    padding:12px 16px;
    font-weight:700;
    min-width:240px;
    max-width:420px;
    box-shadow:0 8px 18px rgba(0,0,0,.08);
    outline:none;
    font-size:.95rem;
  }
  .filter-input::placeholder{ color:#999; font-weight:600; }

  /* Secciones expandibles en revisi√≥n */
  .section-toggle{ margin:12px 0; }
  .section-content{
    margin:8px 0 18px;
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(3px);
    border:2px solid #ddd;
    border-radius:14px;
    padding:14px;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
  }
  .section-content.hidden{ display:none; }

  .evidence-grid{
    display:flex; flex-wrap:wrap; gap:10px;
    justify-content:center;
  }
  .evidence-thumb{
    width:100%; max-width:320px;
    aspect-ratio:4/3;
    object-fit:cover;
    border-radius:10px;
    border:2px solid #ddd;
    background:#eee;
    cursor:zoom-in;
    display:block;
    margin:0 auto;
  }

  @media (max-width: 700px){
    .btn-row{ flex-direction:column; }
    .item-header{ flex-direction:column; align-items:flex-start; }
  }

  /* === Toggle mostrar/ocultar c√©dula (login) === */
  .pwd-wrapper{ position:relative; width:100%; }
  .pwd-wrapper input#login-cedula{
    display:block; width:100%; box-sizing:border-box; padding-right:40px;
  }
  .toggle-cedula{
    position:absolute; top:50%; right:10px;
    transform:translateY(-50%);
    background:transparent !important;
    border:0 !important;
    padding:0;
    width:28px; height:28px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    border-radius:6px;
  }
  .toggle-cedula:hover{ background:rgba(0,0,0,.06); }
  .toggle-cedula:active{ transform:translateY(-50%) scale(.92); }
  .toggle-cedula:focus-visible{
    outline:none;
    box-shadow:0 0 0 3px rgba(6,64,43,.35);
  }
  .toggle-cedula img{
    width:22px; height:22px; display:block; pointer-events:none;
  }
  @media (max-width:480px){
    .pwd-wrapper input#login-cedula{ padding-right:36px; }
    .toggle-cedula{ right:8px; width:26px; height:26px; }
    .toggle-cedula img{ width:20px; height:20px; }
  }

  /* === Alinear √≠conos WhatsApp y Drive en UNA MISMA L√çNEA === */
  .contr-actions{ display:flex; flex-wrap:nowrap; }
  .contr-actions .left-group{
    display:flex;
    gap:12px;
    flex:1 1 auto;
  }
  .contr-actions .right-group{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:12px;
    margin-left:12px;
    flex:0 0 auto;
    min-width:auto;
  }

  /* Objetivo responsive (mantener iconos visibles arriba, botones abajo) */
  @media (max-width:700px){
    .contr-actions{ flex-wrap: wrap !important; align-items: center; }
    .contr-actions .right-group{
      order: 1 !important;
      flex: 0 0 100% !important;
      justify-content: flex-end !important;
      margin-left: 0 !important;
      margin-top: 0 !important;
    }
    .contr-actions .left-group{
      order: 2 !important;
      flex: 0 0 100% !important;
      min-width: 0;
      margin-top: 8px;
      display: flex;
      gap: 12px;
    }
    .contr-actions .left-group > button{ flex: 1 1 48%; }
  }
  @media (max-width:400px){
    .contr-actions .left-group > button{ flex: 1 1 100%; }
  }

 /* === Header ORDENES: nombre + carpeta pegada a la esquina y sin espacio extra abajo === */
.item-header.orden-header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  margin-bottom:0;
  padding-bottom:0;
}

.item-header.orden-header .item-title{
  flex:1 1 auto;
  min-width:0;
  margin:0;              /* quita el margen que genera el ‚Äúespacio‚Äù */
  line-height:1.15;
}

.item-header.orden-header .orden-folder{
  flex:0 0 auto;
  margin-left:10px;
  padding:0 !important;
  position:relative;
  top:0;
  right:0;
}

.item-header.orden-header .orden-folder img{
  width:46px !important;
  height:46px !important;
  display:block;
  filter:drop-shadow(0 2px 4px rgba(0,0,0,.25));
}

/* quita el espacio entre NOMBRE y CC/NIT SOLO en tarjetas de ORDENES */
.item-card .item-header.orden-header + .item-sub{
  margin-top:0 !important;
}

#cuentas-list .item-sub{
  margin:0 !important;
  line-height:1.25;
}
</style>
</head>
<body>
 <!-- Loader -->
<div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
  <div class="spinner-ios" role="status" aria-label="Cargando">
    <i></i><i></i><i></i><i></i><i></i><i></i>
    <i></i><i></i><i></i><i></i><i></i><i></i>
  </div>
</div>

  <div class="container">

    <!-- VISTA INSTALAR -->
    <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP CONTABILIDAD</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1766349498/slider_zcq18s.gif" />
        <p style="font-weight:600;">Herramienta de uso exclusivo para el equipo de Contabilidad de la Alcald√≠a de Flandes</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">CONTABILIDAD</h1>
        <p class="helper"><b>Solo el personal del √°rea de contabilidad de la Alcald√≠a de Flandes est√° autorizado para hacer uso de esta App.</b></p>

        <label>Contrase√±a</label>
        <div class="pwd-wrapper">
          <input
            id="login-cedula"
            type="password"
            inputmode="numeric"
            autocomplete="off"
            placeholder="Sin puntos ni espacios"
          />
          <button
            type="button"
            id="toggle-cedula"
            aria-label="Mostrar c√©dula"
            class="toggle-cedula"
          >
            <img
              src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png"
              alt="Mostrar"
            >
          </button>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        <img class="banner-bottom" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347982/banner_wbfbf7.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="danger" id="btn-logout">Cerrar Sesi√≥n</button>
        </div>

        <h2 id="inicio-profesional" style="color:var(--primary); font-weight:900;"></h2>
        <p id="inicio-fecha" class="center" style="font-weight:700; font-size:.95rem;"></p>

        <div class="btn-row spaced">
          <button id="go-contratistas" class="btn-primary">CONTRATISTAS</button>
          <button id="go-revision" class="btn-primary">ORDEN DE PAGO</button>
          <button id="go-emision" class="btn-primary hidden">EMISI√ìN</button>
          <button id="go-requerimientos" class="btn-primary">REQUERIMIENTO</button>
          <button id="go-comunicados" class="btn-primary">COMUNICADOS</button>
          <button id="go-soporte" class="btn-primary">SOPORTE</button>
        </div>

        <img class="banner-bottom" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347982/banner_wbfbf7.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA CONTRATISTAS -->
    <section id="view-contratistas" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">CONTRATISTAS</h2>

        <div class="center">
          <div id="contr-count" class="tag-count" style="display:none;"></div>
          <p id="contr-caption" class="muted" style="margin:6px 0 12px;">N¬∞ de Contratistas OPS</p>
        </div>

        <input id="contr-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento, secretaria, supervisor o tel√©fono" aria-label="Filtrar contratistas">

        <div class="btn-row spaced">
          <button id="contr-volver" class="danger">REGRESAR</button>
        </div>

        <div id="contr-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA REVISI√ìN DE CUENTAS (PRE-ORDEN) -->
    <section id="view-revision" class="view">
      <div class="card">
        <h2 id="revision-title" style="color:var(--primary)">CUENTAS PENDIENTES DE ORDEN PAGO</h2>

        <div class="center">
          <div id="cuentas-count" class="tag-count" style="display:none;"></div>
          <p id="cuentas-caption" class="muted" style="margin:6px 0 12px;">N¬∞ de Cuentas Pendientes</p>
        </div>

        <input id="cuentas-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento, informe o total informes">

        <div class="btn-row spaced">
          <button id="revision-volver" class="danger">REGRESAR</button>
        </div>

        <div id="cuentas-list" class="list-grid"></div>
      </div>
    </section>

    <!-- VISTA REVISAR CUENTA (se conserva) -->
    <section id="view-revisar-cuenta" class="view">
      <div class="card">
        <h2 id="rc-title" style="color:var(--primary)">REVISI√ìN DE CUENTA</h2>
        <div id="rc-body" class="narrow"></div>

        <div class="section-toggle">
          <button id="btn-toggle-contrato" class="chip">Ver Informaci√≥n del Contrato</button>
        </div>
        <div id="sec-contrato" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-informe" class="chip">Ver Relaci√≥n de Informe y Pago</button>
        </div>
        <div id="sec-informe" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-planilla" class="chip">Ver Relaci√≥n de Planilla</button>
        </div>
        <div id="sec-planilla" class="section-content hidden"></div>

        <div class="section-toggle">
          <button id="btn-toggle-planilla2" class="chip">Ver Relaci√≥n de Planilla Anexa</button>
        </div>
        <div id="sec-planilla2" class="section-content hidden"></div>

        <!-- Bot√≥n CUENTA debajo del bot√≥n de Actividades -->
        <div class="center" style="margin-top:6px;">
          <button
            id="btn-abrir-carpeta-cuenta"
            class="btn-icon hidden"
            aria-label="Abrir carpeta de CUENTA en Drive"
            title="Abrir carpeta de CUENTA en Drive"
          >
            <img
              src="https://res.cloudinary.com/dqqeavica/image/upload/v1764111247/carpeta_drive_epbrhp.webp"
              alt="CUENTA"
            >
          </button>
        </div>

        <div class="btn-row spaced">
          <button id="rc-guardar" class="btn-primary">Guardar</button>
          <button id="rc-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA REQUERIMIENTOS -->
    <section id="view-requerimientos" class="view">
      <div class="card">
        <h2 style="color:var(--primary)">REQUERIMIENTOS</h2>
        <div class="center">
          <div id="req-count" class="tag-count" style="display:none;"></div>
          <p class="muted" style="margin:6px 0 12px;">N¬∞ de Contratistas</p>
        </div>
        <input id="req-filter" class="filter-input" type="text" placeholder="Filtrar por nombre, documento, secretaria, supervisor o tel√©fono">
        <div id="req-list" class="list-grid"></div>
        <div class="btn-row spaced">
          <button id="req-volver" class="danger">REGRESAR</button>
        </div>
      </div>
    </section>

    <!-- MODAL REQUERIMIENTO -->
    <div id="modal-requerimiento" class="modal-backdrop hidden">
      <div class="modal">
        <h3 style="color:var(--primary)">Redacta tu Requerimiento</h3>
        <textarea id="modal-req-text" rows="5" placeholder="Redacta el Requerimiento"></textarea>
        <div class="btn-row" style="margin-top:14px;">
          <button id="modal-req-enviar" class="btn-primary">Enviar</button>
          <button id="modal-req-cancelar" class="danger">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- VISTA COMUNICADOS -->
    <section id="view-comunicados" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">EMITE COMUNICADO</h2>
        <textarea id="comunicado-text" rows="6" placeholder="Escribe tu comunicado"></textarea>
        <div class="btn-row spaced">
          <button id="comunicado-enviar" class="btn-primary">Enviar</button>
          <button id="comunicado-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA SOPORTE -->
    <section id="view-soporte" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">¬øQU√â NECESITAS?</h2>
        <textarea id="soporte-text" rows="6" placeholder="Redacta detalladamente tu pregunta o sugerencia"></textarea>
        <div class="btn-row spaced">
          <button id="soporte-enviar" class="btn-primary">Enviar</button>
          <button id="soporte-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

  </div>

<script>
/* ================== CONFIGURACI√ìN PRINCIPAL ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbw0AX4aP4R5GKAscjqp7JbUa-fHyBc9KYk5iHHqwW__7xn_9r11Qxp1_YAEFMh-mEds/exec';
const BUILDERBOT_ENDPOINT = 'https://app.builderbot.cloud/api/v2/ff37a123-12b0-4fdc-9866-f3e2daf389fb/messages';
const BUILDERBOT_API_KEY  = 'bb-7f9ef630-5cfc-4ba4-9258-5e7cecbb4f65';

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3'
};
function playSoundOnce(url){
  try{
    const a = new Audio(url);
    a.preload = 'auto';
    a.play().catch(()=>{});
  }catch(e){}
}
if (window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
    }catch(e){}
    return __fire(options, ...rest);
  }
}

/* ================== LOADER ================== */
const loader = document.getElementById('loader');
let loadingCount = 0;
let loaderTimer = null;

function startLoading(){
  loadingCount++;
  if (loadingCount === 1){
    loaderTimer = setTimeout(()=>{
      loader.classList.remove('hidden');
      loaderTimer = null;
    }, 120);
  }
}
function stopLoading(){
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    if (loaderTimer){
      clearTimeout(loaderTimer);
      loaderTimer = null;
    }
    loader.classList.add('hidden');
  }
}

/* ================== API HELPERS ================== */
async function apiGet(action, params = {}){
  startLoading();
  try{
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(url.toString(), { method: 'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== BUILDERBOT ================== */
function normalizeContratistaNumber(raw){
  let num = String(raw || '').replace(/\D/g,'');
  if(!num) return '';
  if(num.length === 10 && !num.startsWith('57')){
    num = '57' + num;
  }
  if(!(num.length === 12 && num.startsWith('57'))){
    return '';
  }
  return num;
}

function sendBuilderbotMessage(destino, mensaje){
  const numberField = String(destino || '').trim();
  if(!numberField){
    console.warn('Destino vac√≠o, no se env√≠a BuilderBot');
    return;
  }
  fetch(BUILDERBOT_ENDPOINT, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-builderbot':BUILDERBOT_API_KEY
    },
    body: JSON.stringify({
      messages: { content: mensaje },
      number: numberField,
      checkIfExists: false
    })
  }).catch(err => console.warn('Error enviando BuilderBot', err));
}

/* ================== ESTADO GLOBAL ================== */
let currentUser = null;

/* ================== VISTAS ================== */
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  const v = document.getElementById(id);
  if(v) v.classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ================== LOGIN ================== */
const btnLogin = document.getElementById('btn-login');
const loginCedula = document.getElementById('login-cedula');

/* ================== BOT√ìN OCULTAR - MOSTRAR ================== */
const toggleCedulaBtn = document.getElementById('toggle-cedula');
toggleCedulaBtn.addEventListener('click', ()=>{
  const oculto = loginCedula.type === 'password';
  loginCedula.type = oculto ? 'text' : 'password';
  const nuevoIcono = oculto
    ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
    : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
  const accion = oculto ? 'Ocultar' : 'Mostrar';
  toggleCedulaBtn.setAttribute('aria-label', accion + ' c√©dula');
  toggleCedulaBtn.innerHTML = '<img src="'+nuevoIcono+'" alt="'+accion+'">';
});

btnLogin.addEventListener('click', async () => {
  const cedula = (loginCedula.value || '').trim();
  if (cedula === '') {
    Swal.fire({ icon:'warning', title:'¬øDeseas iniciar Sesi√≥n?', text:'Ingresa tu Contrase√±a.' });
    return;
  }
  if (!/^\d{6,10}$/.test(cedula)) {
    Swal.fire({ icon:'warning', title:'Contrase√±a inv√°lida', text:'Te mostrar√© unas opciones' });
    return;
  }
  try {
    const res = await apiGet('login', { cedula });
    if (!res || !res.encontrado){
      const soporte = '573103230712';
      const mensaje =
        'Buen d√≠a *Oscar*%0A%0ANo tengo acceso a la app de Contrataci√≥n.%0A' +
        'Mi Contrase√±a: *' + cedula + '*%0A' +
        'Te dejo mis datos a continuaci√≥n:%0A*Nombre Completo:*%0A*Celular:*';
      const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
      const urlWA = esMovil
        ? 'whatsapp://send?phone=' + soporte + '&text=' + mensaje
        : 'https://api.whatsapp.com/send?phone=' + soporte + '&text=' + mensaje;

      const rs = await Swal.fire({
        icon: 'error',
        title: 'NO TIENES ACCESO',
        text: 'Toma una de las opciones',
        showConfirmButton: true,
        confirmButtonText: 'Solicitar Acceso',
        showDenyButton: true,
        denyButtonText: 'Rectificar / Salir'
      });

      if (rs.isConfirmed){
        window.open(urlWA, '_blank');
        await Swal.fire({
          icon: 'success',
          title: 'Se abri√≥ WhatsApp',
          text: 'Solicita tu habilitaci√≥n por ese medio.',
          timer: 6000,
          showConfirmButton: false
        });
        return;
      } else if (rs.isDenied){
        loginCedula.value = '';
        return;
      }
    }

    currentUser = {
      cedula,
      profesional: res.profesional || '',
      celular: res.celular || ''
    };
    playSoundOnce(SOUNDS.login);
    renderInicio();
    updateEmisionButtonVisibility();
    showView('view-inicio');
  } catch (e) {
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser = null;
  loginCedula.value = '';
  showView('view-login');
});

/* ================== INICIO ================== */
function renderInicio(){
  document.getElementById('inicio-profesional').textContent = 'PROFESIONAL: ' + (currentUser?.profesional || '');
  document.getElementById('inicio-fecha').textContent = formatoFechaHumana(new Date());
}
function formatoFechaHumana(date){
  const dias=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
  const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const d=dias[date.getDay()];
  const dia=('0'+date.getDate()).slice(-2);
  const mes=meses[date.getMonth()];
  const y=date.getFullYear();
  return `${d}, ${dia} de ${mes} de ${y}`;
}

/* ================== PERMISOS EMISI√ìN ================== */
function updateEmisionButtonVisibility(){
  const btn = document.getElementById('go-emision');
  if(!btn) return;
  const name = String(currentUser?.profesional || '').trim().toUpperCase();
  const allowed = (name === 'OSCAR POLANIA' || name === 'SANDRA CASTILLO');
  btn.classList.toggle('hidden', !allowed);
}

/* ================== NAVEGACI√ìN PRINCIPAL ================== */
document.getElementById('go-contratistas').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  await cargarContratistas();
  showView('view-contratistas');
});

let ORDEN_MODE = 'CREACION'; // 'CREACION' (CERRADA) | 'EMISION' (PRE-ORDEN)

document.getElementById('go-revision').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  ORDEN_MODE = 'CREACION';
  await cargarCuentasPendientes(); // usa ORDEN_MODE
  if (!CUENTAS_DATA || CUENTAS_DATA.length === 0){
    await Swal.fire({
      icon:'success',
      title:'¬°Est√°s al d√≠a!',
      text:'No tienes CUENTAS pendientes por Orden de Pago',
      timer: 3200,
      showConfirmButton: false
    });
    showView('view-inicio');
    return;
  }
  showView('view-revision');
});

document.getElementById('go-emision').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  ORDEN_MODE = 'EMISION';
  await cargarCuentasPendientes(); // lista PRE-ORDEN
  if (!CUENTAS_DATA || CUENTAS_DATA.length === 0){
    await Swal.fire({
      icon:'success',
      title:'¬°Sin pendientes!',
      text:'No hay PRE-ORDENES pendientes por emitir.',
      timer: 3200,
      showConfirmButton: false
    });
    showView('view-inicio');
    return;
  }
  showView('view-revision');
});

document.getElementById('go-requerimientos').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  await cargarRequerimientosBase();
  showView('view-requerimientos');
});
document.getElementById('go-comunicados').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  showView('view-comunicados');
});
document.getElementById('go-soporte').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  showView('view-soporte');
});

/* ================== CONTRATISTAS ================== */
let CONTR_DATA=[];
async function cargarContratistas(){
  try{
    const list=await apiGet('listContratistas');
    CONTR_DATA=Array.isArray(list)?list:[];
    pintarContratistas(CONTR_DATA);
    actualizarResumenContratistas(CONTR_DATA);
  }catch(e){
    CONTR_DATA=[];
    pintarContratistas(CONTR_DATA);
    actualizarResumenContratistas(CONTR_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function actualizarResumenContratistas(list){
  const box=document.getElementById('contr-count');
  if(!box) return;
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length);
  box.style.display='inline-block';
}
function pintarContratistas(list){
  const wrap=document.getElementById('contr-list');
  if(!wrap) return;
  wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<p class="muted center">No hay contratistas activos.</p>';
    return;
  }
  for(const c of list){
    const div=document.createElement('div');
    div.className='item-card';

    const header=document.createElement('div');
    header.className='item-header';

    const title=document.createElement('p');
    title.className='item-title';
    title.textContent= (c.nombre||'');

    header.appendChild(title);
    div.appendChild(header);

    const pDoc=document.createElement('p');
    pDoc.className='item-sub';
    pDoc.textContent='CC / NIT: '+(c.documento||'');
    div.appendChild(pDoc);

    const pSec=document.createElement('p');
    pSec.className='item-sub';
    pSec.textContent='SECRETAR√çA: '+(c.secretaria||'');
    div.appendChild(pSec);

    const pSup=document.createElement('p');
    pSup.className='item-sub';
    pSup.textContent='SUPERVISOR: '+(c.supervisor||'');
    div.appendChild(pSup);

    const pContrato=document.createElement('p');
    pContrato.className='item-sub';
    pContrato.textContent='CONTRATO: '+(c.contrato||'')+' de: '+(c.fechaContrato||'');
    div.appendChild(pContrato);

    const pInicio=document.createElement('p');
    pInicio.className='item-sub';
    pInicio.textContent='FECHA INICIO: '+(c.fechaInicio||'');
    div.appendChild(pInicio);

    const pTermino=document.createElement('p');
    pTermino.className='item-sub';
    pTermino.textContent='FECHA TERMINO: '+(c.fechaTermino||'');
    div.appendChild(pTermino);

    const actionsRow=document.createElement('div');
    actionsRow.className='contr-actions';

    const leftGroup=document.createElement('div');
    leftGroup.className='left-group';

    const rightGroup=document.createElement('div');
    rightGroup.className='right-group';

    const btnDetalles=document.createElement('button');
    btnDetalles.textContent='MOSTRAR DETALLES';
    btnDetalles.addEventListener('click', ()=>{
      playSoundOnce(SOUNDS.login);
      mostrarDetallesContratista(c.documento); // se mantiene para la vista contratistas
    });

    const btnWhatsapp=document.createElement('button');
    btnWhatsapp.className='btn-icon';
    btnWhatsapp.innerHTML='<img src="https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp" alt="WhatsApp">';
    btnWhatsapp.setAttribute('aria-label','Abrir chat de WhatsApp');
    btnWhatsapp.addEventListener('click', ()=>{
      let tel=String(c.telefono||'').replace(/\D/g,'');
      if(!tel){ Swal.fire({icon:'info',title:'Sin tel√©fono'}); return; }
      if(!tel.startsWith('57')) tel='57'+tel;
      if(!/^57\d{10}$/.test(tel)){
        Swal.fire({icon:'warning',title:'Tel√©fono inv√°lido'}); return;
      }
      window.open('https://wa.me/'+tel,'_blank');
    });

    const btnDrive=document.createElement('button');
    btnDrive.className='btn-icon';
    btnDrive.innerHTML='<img src="https://res.cloudinary.com/dqqeavica/image/upload/v1763997280/DRIVE_bycgsc.webp" alt="Drive">';
    btnDrive.setAttribute('aria-label','Abrir carpeta Drive');
    btnDrive.addEventListener('click', ()=>{
      if(c.carpetaContratista){
        window.open('https://drive.google.com/drive/folders/'+c.carpetaContratista,'_blank');
      }else{
        Swal.fire({icon:'info',title:'Sin carpeta',text:'No hay carpeta asociada.'});
      }
    });

    leftGroup.appendChild(btnDetalles);
    rightGroup.appendChild(btnWhatsapp);
    rightGroup.appendChild(btnDrive);
    actionsRow.appendChild(leftGroup);
    actionsRow.appendChild(rightGroup);

    div.appendChild(actionsRow);
    wrap.appendChild(div);
  }
}

document.getElementById('contr-filter').addEventListener('input',()=>{
  const qRaw = document.getElementById('contr-filter').value.trim().toLowerCase();
  const digits = qRaw.replace(/\D/g,'');
  const buscarDocumento = digits.length >= 5;

  const filtered = CONTR_DATA.filter(c=>{
    const base = [c.nombre,c.secretaria,c.supervisor,c.telefono,c.contrato]
      .some(v=>String(v||'').toLowerCase().includes(qRaw));

    if(base) return true;

    if(buscarDocumento){
      return String(c.documento||'').toLowerCase().includes(qRaw);
    }
    return false;
  });

  pintarContratistas(filtered);
  actualizarResumenContratistas(filtered);
});
document.getElementById('contr-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== DETALLES CONTRATISTA (se mantiene) ================== */
async function mostrarDetallesContratista(documento){
  try{
    const d=await apiGet('detallesContratista',{documento});
    const body=document.getElementById('detalles-body');
    // NOTA: la vista detalles de contratista a√∫n existe en tu HTML original,
    // pero en este archivo la eliminamos para ‚ÄúOrden de Pago‚Äù solamente.
    // Como aqu√≠ no existe #view-detalles en este index actualizado, mostramos en alerta.
    if(!d){
      Swal.fire({icon:'info',title:'No encontrado'});
      return;
    }
    const lines=[
      `NOMBRE: ${d.nombre||''}`,
      `CC / NIT: ${d.documento||''} de: ${d.expedida||''}`,
      `TEL√âFONO: ${d.telefono||'SIN REGISTRO'}`,
      `CORREO: ${d.correo||'SIN REGISTRO'}`,
      `CUENTA: ${d.cuenta||''} ${d.tipoCuenta||''} ${d.banco||''}`,
      `EPS: ${d.eps||''}`,
      `AFP: ${d.pension||''}`,
      `ARL: ${d.arl||''}`,
      `SECRETAR√çA: ${d.secretaria||''}`,
      `SUPERVISOR: ${d.supervisor||''}`,
      `CONTRATO: ${d.contrato||''} de: ${d.fechaContrato||''}`,
      `OBJETO: ${d.objeto||''}`,
      `FECHA DE INICIO: ${d.fechaInicio||''}`,
      `FECHA DE TERMINO: ${d.fechaTermino||''}`,
      `VALOR INICIAL: ${d.valor||''}`,
      `MRA: ${d.mra||''}`,
      `VALOR FINAL: ${d.valorFinal||''}`,
      `CDP: ${d.cdp||''}`,
      `RP: ${d.rp||''}`,
      `CDP ADICI√ìN: ${d.cdpAdicion||''}`,
      `RP ADICI√ìN: ${d.rpAdicion||''}`,
      `REGIMEN: ${d.regimen||''}`
    ];
    Swal.fire({
      icon:'info',
      title:'Detalles de Contratista',
      html: '<div style="text-align:left; font-weight:600; white-space:pre-line;">'+lines.join('\n')+'</div>'
    });
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}

/* ================== ORDENES (Listado unificado) ================== */
let CUENTAS_DATA=[];
async function cargarCuentasPendientes(){
  try{
    const estado = (ORDEN_MODE === 'EMISION') ? 'PRE-ORDEN' : 'CERRADA';
    const list = await apiGet('listCuentasPorEstado', { estado });
    CUENTAS_DATA = Array.isArray(list) ? list : [];
    configurarTituloOrdenes();
    pintarCuentas(CUENTAS_DATA);
    actualizarResumenCuentas(CUENTAS_DATA);
  }catch(e){
    CUENTAS_DATA=[];
    configurarTituloOrdenes();
    pintarCuentas(CUENTAS_DATA);
    actualizarResumenCuentas(CUENTAS_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function configurarTituloOrdenes(){
  const title = document.getElementById('revision-title');
  const caption = document.getElementById('cuentas-caption');
  if(!title || !caption) return;

  if(ORDEN_MODE === 'EMISION'){
    title.textContent = 'EMISI√ìN - PRE-ORDENES PENDIENTES';
    caption.textContent = 'N¬∞ de Pre-Ordenes Pendientes';
  } else {
    title.textContent = 'CUENTAS PENDIENTES DE ORDEN PAGO';
    caption.textContent = 'N¬∞ de Cuentas Pendientes';
  }
}
function actualizarResumenCuentas(list){
  const box=document.getElementById('cuentas-count');
  if(!box) return;
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length);
  box.style.display='inline-block';
}

function pintarCuentas(list){
  const wrap=document.getElementById('cuentas-list');
  wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<p class="muted center">No hay cuentas pendientes.</p>';
    return;
  }
  for(const c of list){
    const div=document.createElement('div');
    div.className='item-card';

    const header=document.createElement('div');
    header.className='item-header orden-header';

    const title=document.createElement('p');
    title.className='item-title';
    title.textContent= (c.nombre||'');
    header.appendChild(title);

    // √çcono carpeta a BH (idCuenta) arriba a la derecha SIN desacomodar
    const folderBtn = document.createElement('button');
    folderBtn.className = 'btn-icon orden-folder';
    folderBtn.title = 'Abrir carpeta de CUENTA';
    folderBtn.setAttribute('aria-label','Abrir carpeta de CUENTA');
    folderBtn.innerHTML = '<img src="https://res.cloudinary.com/dqqeavica/image/upload/v1764111247/carpeta_drive_epbrhp.webp" alt="CUENTA">';
    folderBtn.addEventListener('click', ()=>{
      playSoundOnce(SOUNDS.login);
      const idCuenta = String(c.idCuenta || '').trim();
      if(idCuenta){
        window.open('https://drive.google.com/drive/folders/' + idCuenta, '_blank');
      }else{
        Swal.fire({icon:'info',title:'Sin carpeta',text:'Esta cuenta no tiene id de carpeta (BH) asociado.'});
      }
    });
    header.appendChild(folderBtn);

    const pDoc=document.createElement('p');
    pDoc.className='item-sub';
    pDoc.textContent='CC / NIT: '+(c.documento||'');

    const pContrato=document.createElement('p');
    pContrato.className='item-sub';
    pContrato.textContent='CONTRATO: '+(c.contrato||'');

    const pInf=document.createElement('p');
    pInf.className='item-sub';
    pInf.textContent='INFORME: '+(c.informe||'')+' de: '+(c.totalInformes||'');

    const facturaVal = String(c.facturaElectronica||'').trim();
    const pFactura=document.createElement('p');
    pFactura.className='item-sub';
    pFactura.textContent='FACTURA ELECTR√ìNICA N¬∞: '+(facturaVal ? facturaVal : 'N/A');

    const pSup=document.createElement('p');
    pSup.className='item-sub';
    pSup.textContent='SUPERVISOR: '+(c.supervisorCuenta||'');

    const btnRow=document.createElement('div');
    btnRow.className='btn-row';

    const btnAccion=document.createElement('button');
    btnAccion.textContent = (ORDEN_MODE === 'EMISION') ? 'EMITIR' : 'ORDEN CREADA';
    btnAccion.addEventListener('click', async ()=>{
      playSoundOnce(SOUNDS.login);
      if(ORDEN_MODE === 'EMISION'){
        await emitirOrdenPagoFlow(c);
      }else{
        await crearPreOrdenFlow(c);
      }
    });
    btnRow.appendChild(btnAccion);

    div.appendChild(header);
    div.appendChild(pDoc);
    div.appendChild(pContrato);
    div.appendChild(pInf);
    div.appendChild(pFactura);
    div.appendChild(pSup);
    div.appendChild(btnRow);
    wrap.appendChild(div);
  }
}
  
document.getElementById('cuentas-filter').addEventListener('input',()=>{
  const qRaw = document.getElementById('cuentas-filter').value.trim().toLowerCase();
  const digits = qRaw.replace(/\D/g,'');
  const buscarDocumento = digits.length >= 5;

  const filtered = CUENTAS_DATA.filter(c=>{
    const base = [c.nombre,c.informe,c.totalInformes,c.contrato,c.facturaElectronica,c.supervisorCuenta]
      .some(v=>String(v||'').toLowerCase().includes(qRaw));

    if(base) return true;

    if(buscarDocumento){
      return String(c.documento||'').toLowerCase().includes(qRaw);
    }
    return false;
  });

  pintarCuentas(filtered);
  actualizarResumenCuentas(filtered);
});
document.getElementById('revision-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== FLOW 1: CREAR PRE-ORDEN ================== */
async function crearPreOrdenFlow(c){
  // Alerta basada en tu antigua de Guardar, adaptada a "GUARDAR ORDEN"
  const nombre = c.nombre || '';
  const informe = c.informe || '';
  const total = c.totalInformes || '';
  const cuentaText = String(informe) + ' de ' + String(total);

  const rs = await Swal.fire({
    icon:'success',
    title:`Cuenta N¬∞ ${informe} de ${nombre}`,
    text:'Toma una de las opciones.',
    showCancelButton:true,
    confirmButtonText:'GUARDAR ORDEN',
    cancelButtonText:'Cancelar'
  });

  if(!rs.isConfirmed) return;

  try{
    await apiPost('crearPreOrden', {
      documento: c.documento,
      informe: c.informe,
      responsable: currentUser?.profesional || ''
    });

    Swal.fire({icon:'success',title:'Pre-Orden creada',timer:1600,showConfirmButton:false});

    await cargarCuentasPendientes(); // refresca (ya no debe aparecer en CERRADA)
    showView('view-revision');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}

/* ================== FLOW 2: EMITIR ORDEN DE PAGO ================== */
async function emitirOrdenPagoFlow(c){
  const documento = c.documento;
  const nombre = c.nombre || '';
  const informe = c.informe || '';

  const telContratistaRaw = c.telefono || '';
  const telContratista = normalizeContratistaNumber(telContratistaRaw);

  const TESORERIA_GROUP_ID = 'KQyQKkptgOI56Qbn6gsJUh'; /*Grupo de tesorer√≠a*/

  const rs = await Swal.fire({
    icon:'success',
    title:`Pre-Orden N¬∞ ${informe} de ${nombre}`,
    text:'¬øDeseas EMITIR la Orden de Pago?',
    showCancelButton:true,
    confirmButtonText:'EMITIR',
    cancelButtonText:'Cancelar'
  });

  function msgOrdenPagoContratista(){
    return (
      '> Estado 4Ô∏è‚É£\n' +
      'Estimado(a) *'+nombre+'*\n\n' +
      '¬°Ha sido emitada la orden de pago de tu *Cuenta N¬∞ '+informe+'*\n' +
      'El equipo de *Tesor√≠a* revisar√° la informaci√≥n para generar el Egreso y Pago de tus honorarios.\n' +
      '> Recuerda que, el proceso se realiza en orden de solicitudes. Agradecemos tu comprensi√≥n\n\n' +
      'Cordialmente,\n\n*Equipo de Contabilidad*\n> Alcald√≠a de Flandes'
    );
  }

  function msgOrdenPagoTesoreria(){
    return (
      'Estimado Equipo de Tesorer√≠a\n\n' +
      'Se ha generado la *Orden de Pago* de la *Cuenta N¬∞ '+informe+'* del contratista *'+nombre+'*\n\n' +
      'Por favor revisar para generar Egreso.\n\n' +
      'Cordialmente,\n\n*Equipo de Contabilidad*'
    );
  }

  if(!rs.isConfirmed) return;

  try{
    // Backend SOLO actualiza estados (CUENTAS BJ -> ORDEN DE PAGO y ORDENES F -> EMITIDO)
    await apiPost('emitirOrdenPagoV2', {
      documento,
      informe,
      responsable: currentUser?.profesional || ''
    });

    // Env√≠o WhatsApp SOLO desde aqu√≠ (como lo quer√≠as)
    if(telContratista){
      sendBuilderbotMessage(telContratista, msgOrdenPagoContratista());
    }
    sendBuilderbotMessage(TESORERIA_GROUP_ID, msgOrdenPagoTesoreria());

    Swal.fire({icon:'success',title:'Orden de Pago Emitida',timer:1800,showConfirmButton:false});
    await cargarCuentasPendientes();
    showView('view-revision');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}

/* ================== REVISAR CUENTA (Detalle) ================== */

function resetSeccionesRevision(){
  const parts = [
    { sec:'sec-contrato',   btn:'btn-toggle-contrato',  label:'Ver Informaci√≥n del Contrato' },
    { sec:'sec-informe',    btn:'btn-toggle-informe',   label:'Ver Relaci√≥n de Informe y Pago' },
    { sec:'sec-planilla',   btn:'btn-toggle-planilla',  label:'Ver Relaci√≥n de Planilla' },
    { sec:'sec-planilla2',  btn:'btn-toggle-planilla2', label:'Ver Relaci√≥n de Planilla Anexa' },
  ];
  parts.forEach(({sec, btn, label})=>{
    const s = document.getElementById(sec);
    const b = document.getElementById(btn);
    if (s) s.classList.add('hidden');
    if (b) b.textContent = label;
  });
}

let REV_CUENTA=null;
async function abrirRevisionCuenta(documento){
  try{
    const data=await apiGet('revisarCuentaData',{documento});
    if(!data){
      Swal.fire({icon:'info',title:'No encontrado'}); return;
    }
    REV_CUENTA=data;
    resetSeccionesRevision();
    renderRevisionCuenta();
    showView('view-revisar-cuenta');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function renderRevisionCuenta(){
  const c=REV_CUENTA?.contratista;
  const cu=REV_CUENTA?.cuenta;
  const rcTitle=document.getElementById('rc-title');
  const rcBody=document.getElementById('rc-body');
  rcTitle.textContent='REVISI√ìN DE CUENTA N¬∞ '+(cu?.informe||'')+' de '+(c?.nombre||'');
  rcBody.innerHTML='';
  const baseInfo=[
    `<b>DOCUMENTO:</b> ${c?.documento||''}`,
    `<b>SECRETAR√çA:</b> ${c?.secretaria||''}`,
    `<b>SUPERVISOR:</b> ${c?.supervisor||''}`
  ];
  rcBody.innerHTML=baseInfo.map(x=>`<p>${x}</p>`).join('');

  const sContrato=document.getElementById('sec-contrato');
  sContrato.innerHTML=[
    `<b>CONTRATO N¬∞:</b> ${c?.contrato||''}`,
    `<b>FECHA DE CONTRATO:</b> ${c?.fechaContrato||''}`,
    `<b>FECHA DE INICIO:</b> ${c?.fechaInicio||''}`,
    `<b>FECHA DE TERMINO:</b> ${c?.fechaTermino||''}`,
    `<b>VALOR INICIAL:</b> ${c?.valor || '-'}`,
    `<b>MRA:</b> ${c?.mra||''}`,
    `<b>VALOR FINAL:</b> ${c?.valorFinal||''}`,
    `<b>CDP:</b> ${c?.cdp||''}`,
    `<b>RP:</b> ${c?.rp||''}`,
    `<b>CDP ADICI√ìN:</b> ${c?.cdpAdicion||''}`,
    `<b>RP ADICI√ìN:</b> ${c?.rpAdicion||''}`,
    `<b>SECRETAR√çA:</b> ${c?.secretaria||''}`,
    `<b>SUPERVISOR:</b> ${c?.supervisor||''}`,
  ].map(x=>`<p>${x}</p>`).join('');

  const sInforme=document.getElementById('sec-informe');
  sInforme.innerHTML=[
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE INFORME</h4>`,
    `<p><b>FECHA DE RADICACI√ìN:</b> ${cu?.fechaRadicacion||''}</p>`,
    `<p><b>INFORME:</b> ${cu?.informe||''} de ${cu?.totalInformes||''}</p>`,
    `<p><b>INICIO DE PERIODO RATIFICADO:</b> ${cu?.inicioRatificar||''}</p>`,
    `<p><b>FIN DE PERIODO RATIFICADO:</b> ${cu?.finRatificar||''}</p>`,
    `<h4 style="margin:14px 0 4px;color:var(--primary)">RELACI√ìN DE PAGO</h4>`,
    `<p><b>SALDO ACTUAL:</b> ${cu?.saldoActual||''}</p>`,
    `<p><b>VALOR COBRADO:</b> ${cu?.menos||''}</p>`,
    `<p><b>NUEVO SALDO:</b> ${cu?.nuevoSaldo||''}</p>`
  ].join('');

  const sPlanilla=document.getElementById('sec-planilla');
  sPlanilla.innerHTML=[
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE PLANILLA</h4>`,
    `<p><b>PLANILLA N¬∞:</b> ${cu?.planilla||''} de ${cu?.mesPlanilla||''}</p>`,
    `<p><b>BASE DE COTIZACI√ìN:</b> ${cu?.base||''}</p>`,
    `<p><b>APORTES A SALUD:</b> ${cu?.salud||''}</p>`,
    `<p><b>APORTES A PENSI√ìN:</b> ${cu?.fondo||''}</p>`,
    `<p><b>APORTES A ARL:</b> ${cu?.riesgos||''}</p>`,
    `<p><b>APORTES FPS:</b> ${cu?.solidario||''} ${cu?.aporte||''}</p>`
  ].join('');

  const sPlanilla2=document.getElementById('sec-planilla2');
  sPlanilla2.innerHTML=[
    `<h4 style="margin:4px 0;color:var(--primary)">RELACI√ìN DE PLANILLA ANEXA</h4>`,
    `<p><b>PLANILLA ANEXA N¬∞:</b> ${cu?.planilla2||''} de ${cu?.mesPlanilla2||''}</p>`,
    `<p><b>BASE DE COTIZACI√ìN:</b> ${cu?.base2||''}</p>`,
    `<p><b>APORTES A SALUD:</b> ${cu?.salud2||''}</p>`,
    `<p><b>APORTES A PENSI√ìN:</b> ${cu?.fondo2||''}</p>`,
    `<p><b>APORTES A ARL:</b> ${cu?.riesgos2||''}</p>`,
    `<p><b>APORTES FPS:</b> ${cu?.solidario2||''} ${cu?.aporte2||''}</p>`
  ].join('');

  const cuentaBtn = document.getElementById('btn-abrir-carpeta-cuenta');
  if (cu?.informe && c?.carpetaContratista){
    cuentaBtn.classList.remove('hidden');
    cuentaBtn.dataset.parent  = c.carpetaContratista;
    cuentaBtn.dataset.informe = String(cu.informe).trim();
    if (cu?.idCuenta){
      cuentaBtn.dataset.subId = String(cu.idCuenta).trim();
    } else {
      delete cuentaBtn.dataset.subId;
    }
  } else {
    cuentaBtn.classList.add('hidden');
    delete cuentaBtn.dataset.parent;
    delete cuentaBtn.dataset.informe;
    delete cuentaBtn.dataset.subId;
  }
}

document.getElementById('rc-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  resetSeccionesRevision();
  showView('view-revision');
});

// Abrir carpeta CUENTA en Drive
const btnAbrirCarpetaCuenta = document.getElementById('btn-abrir-carpeta-cuenta');
btnAbrirCarpetaCuenta.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);

  const subId = btnAbrirCarpetaCuenta.dataset.subId || '';
  const parentId = btnAbrirCarpetaCuenta.dataset.parent || REV_CUENTA?.contratista?.carpetaContratista || '';

  if (subId){
    window.open('https://drive.google.com/drive/folders/' + subId, '_blank');
    return;
  }
  if (parentId){
    Swal.fire({ icon:'info', title:'Falta id de CUENTA', text:'Se abrir√° la carpeta del contratista.' });
    window.open('https://drive.google.com/drive/folders/' + parentId, '_blank');
  } else {
    Swal.fire({ icon:'info', title:'Sin carpeta', text:'Este contratista no tiene "carpetaContratista" asociada.' });
  }
});

function initRevisionToggleSections(){
  const defs = [
    ['btn-toggle-contrato','sec-contrato','Ver Informaci√≥n del Contrato','Ocultar Informaci√≥n del Contrato'],
    ['btn-toggle-informe','sec-informe','Ver Relaci√≥n de Informe y Pago','Ocultar Relaci√≥n de Informe y Pago'],
    ['btn-toggle-planilla','sec-planilla','Ver Relaci√≥n de Planilla','Ocultar Relaci√≥n de Planilla'],
    ['btn-toggle-planilla2','sec-planilla2','Ver Relaci√≥n de Planilla Anexa','Ocultar Relaci√≥n de Planilla Anexa']
  ];
  defs.forEach(([btnId,secId,showTxt,hideTxt])=>{
    const btn = document.getElementById(btnId);
    const sec = document.getElementById(secId);
    if(!btn || !sec) return;
    if(btn.dataset.bound) return;
    btn.dataset.bound = '1';
    btn.addEventListener('click',()=>{
      const visible = !sec.classList.contains('hidden');
      if(visible){
        sec.classList.add('hidden');
        btn.textContent = showTxt;
      }else{
        sec.classList.remove('hidden');
        btn.textContent = hideTxt;
      }
    });
  });
}
initRevisionToggleSections();

/* ================== REQUERIMIENTOS ================== */
let REQ_DATA=[];
async function cargarRequerimientosBase(){
  try{
    const list=await apiGet('listContratistas');
    REQ_DATA=Array.isArray(list)?list:[];
    pintarRequerimientos(REQ_DATA);
    actualizarResumenReq(REQ_DATA);
  }catch(e){
    REQ_DATA=[];
    pintarRequerimientos(REQ_DATA);
    actualizarResumenReq(REQ_DATA);
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
}
function actualizarResumenReq(list){
  const box=document.getElementById('req-count');
  if(!box) return;
  if(!list.length){ box.style.display='none'; box.textContent=''; return; }
  box.textContent=String(list.length);
  box.style.display='inline-block';
}
function pintarRequerimientos(list){
  const wrap=document.getElementById('req-list');
  wrap.innerHTML='';
  if(!list.length){
    wrap.innerHTML='<p class="muted center">No hay contratistas.</p>';
    return;
  }
  for(const c of list){
    const div=document.createElement('div');
    div.className='item-card';

    const header=document.createElement('div');
    header.className='item-header';

    const title=document.createElement('p');
    title.className='item-title';
    title.textContent='NOMBRE: '+(c.nombre||'');
    header.appendChild(title);
    div.appendChild(header);

    const pSup=document.createElement('p');
    pSup.className='item-sub';
    pSup.textContent='SUPERVISOR: '+(c.supervisor||'');
    div.appendChild(pSup);

    const pSec=document.createElement('p');
    pSec.className='item-sub';
    pSec.textContent='SECRETAR√çA: '+(c.secretaria||'');
    div.appendChild(pSec);

    const btnRow=document.createElement('div');
    btnRow.className='btn-row';

    const btnRedact=document.createElement('button');
    btnRedact.textContent='REDACTAR';
    btnRedact.addEventListener('click', ()=>{
      playSoundOnce(SOUNDS.login);
      abrirModalRequerimiento(c);
    });

    btnRow.appendChild(btnRedact);
    div.appendChild(btnRow);

    wrap.appendChild(div);
  }
}
  
document.getElementById('req-filter').addEventListener('input',()=>{
  const q=document.getElementById('req-filter').value.trim().toLowerCase();
  const filtered=REQ_DATA.filter(c=>{
    return [c.nombre,c.documento,c.secretaria,c.supervisor,c.telefono]
      .some(v=>String(v||'').toLowerCase().includes(q));
  });
  pintarRequerimientos(filtered);
  actualizarResumenReq(filtered);
});
document.getElementById('req-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== MODAL REQUERIMIENTO ================== */
let MODAL_TARGET=null;
function abrirModalRequerimiento(c){
  MODAL_TARGET=c;
  document.getElementById('modal-req-text').value='';
  document.getElementById('modal-requerimiento').classList.remove('hidden');
}
document.getElementById('modal-req-cancelar').addEventListener('click',()=>{
  document.getElementById('modal-requerimiento').classList.add('hidden');
});
document.getElementById('modal-req-enviar').addEventListener('click',()=>{
  const txt=(document.getElementById('modal-req-text').value||'').trim();
  if(!MODAL_TARGET){ return; }
  if(!txt){
    Swal.fire({icon:'warning',title:'Texto requerido'}); return;
  }

  const supervisor = (MODAL_TARGET.supervisor || '').trim();
  const grupoSupervisorId = String(MODAL_TARGET.contacto || '').trim();
  const requerimiento = txt;

  function msgRequerimiento(){
    return (
      'Estimado(a) *' + supervisor + '*\n\n' +
      'Tenemos el siguiente requerimiento:\n' +
      '*' + requerimiento + '*\n\n' +
      'Cordialmente,\n\n*Equipo de Contabilidad*'
    );
  }

  if (grupoSupervisorId){
    sendBuilderbotMessage(grupoSupervisorId, msgRequerimiento());
  } else {
    Swal.fire({ icon:'warning', title:'Sin grupo', text:'Este supervisor no tiene id de grupo (Columna F) asociado.' });
    return;
  }

  document.getElementById('modal-requerimiento').classList.add('hidden');
  Swal.fire({icon:'success',title:'Requerimiento enviado',timer:1800,showConfirmButton:false});
});
  
/* ================== COMUNICADOS ================== */
document.getElementById('comunicado-enviar').addEventListener('click',async()=>{
  const txt=(document.getElementById('comunicado-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarComunicado',{
      profesional: currentUser?.profesional || '',
      noticia: txt
    });
    Swal.fire({icon:'success',title:'COMUNICADO CARGADO CON √âXITO',timer:4000,showConfirmButton:false});
    document.getElementById('comunicado-text').value='';
    renderInicio();
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('comunicado-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== SOPORTE ================== */
document.getElementById('soporte-enviar').addEventListener('click',async()=>{
  const txt=(document.getElementById('soporte-text').value||'').trim();
  if(!txt){ Swal.fire({icon:'warning',title:'Texto requerido'}); return; }
  try{
    await apiPost('guardarSoporte',{
      profesional: currentUser?.profesional || '',
      soporte: txt,
      celular: currentUser?.celular || ''
    });
    Swal.fire({icon:'success',title:'SOLICITUD CARGADA CON √âXITO',timer:4000,showConfirmButton:false});
    document.getElementById('soporte-text').value='';
    renderInicio();
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:e.message});
  }
});
document.getElementById('soporte-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

/* ================== PWA AVANZADO (igual) ================== */
let deferredPrompt = null;
let __installStartShown = false;
let __installSuccessShown = false;

function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const dmInstalled  = window.matchMedia('(display-mode: installed)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  return dmStandalone || dmInstalled || iosStandalone;
}
function isIOS(){
  return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
}
function isMarkedInstalled(){
  try{ return localStorage.getItem('pwaInstalledFlag') === '1'; }catch(_){ return false; }
}
function markInstalled(){
  try{ localStorage.setItem('pwaInstalledFlag', '1'); }catch(_){}
}
function clearInstalledMark(){
  try{ localStorage.removeItem('pwaInstalledFlag'); }catch(_){}
}
async function detectInstalled(){
  if (isStandalone()) return true;
  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a =>
        a.platform === 'webapp' &&
        typeof a.url === 'string' &&
        /manifest\.webmanifest$/.test(a.url)
      );
      if (found){
        markInstalled();
        return true;
      } else {
        clearInstalledMark();
      }
    }catch(_){}
  }
  return isMarkedInstalled();
}
function updateInstallButtonsVisibility(){
  const btn1 = document.getElementById('btn-instalar');
  const canPrompt = !!deferredPrompt;
  const installed = isMarkedInstalled() || isStandalone();
  const shouldShow = !installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  updateInstallButtonsVisibility();
});

window.addEventListener('appinstalled', ()=>{
  markInstalled();
  deferredPrompt = null;
  updateInstallButtonsVisibility();
});

document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  if(isIOS()){
    Swal.fire({
      icon:'info',
      title: '¬°Para Instalar en tu Iphone!',
      html: `
        <div style="text-align:center; margin-top:8px;">
          <img
            src="https://res.cloudinary.com/dqqeavica/image/upload/v1765745210/instalacion_ios_ysbhnd.gif"
            alt="Instalaci√≥n de IOS"
            style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
          >
          <div style="margin-top:10px;">
            <b>1.</b> Toca Compartir.<br><b>2.</b> Elige "Agregar a pantalla de inicio".<br><b>3.</b> Confirma "Agregar".
          </div>
        </div>
      `,
    });
    return;
  }
  if(!deferredPrompt){
    Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'});
    return;
  }

  const dp = deferredPrompt;
  dp.prompt();
  const choice = await dp.userChoice;
  deferredPrompt = null;

  if (choice.outcome === 'accepted'){
    markInstalled();
    __installStartShown = true;
    Swal.fire({
      icon: 'success',
      title: '¬°App instal√°ndose!',
      html: `
        <div style="text-align:center; margin-top:8px;">
          <img
            src="https://res.cloudinary.com/dqqeavica/image/upload/v1765740540/instalacion_lydtcl.gif"
            alt="Instalando app"
            style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
          >
          <div>Debes esperar unos segundos mientras el sistema instala la App.</div>
          <div style="margin-top:10px;">
            <b>Al desaparecer este aviso, puedes salir de esta vista. La App aparecer√° en la pantalla principal de este dispositivo.</b>
          </div>
        </div>
      `,
      timer: 12000,
      showConfirmButton: false
    });
  } else {
    Swal.fire({icon:'info',title:'Instalaci√≥n cancelada'});
  }

  updateInstallButtonsVisibility();
});

async function initPWAVista(){
  const installed = await detectInstalled();
  if (installed){
    showView('view-login');
  } else {
    showView('view-instalar');
    updateInstallButtonsVisibility();
  }
}
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
window.addEventListener('load', initPWAVista);

/* ================== FIN ================== */
</script>
</body>
</html>
